<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Judge Dashboard</title>
  <style>
    body { font-family: Arial; max-width: 800px; margin: 20px auto; padding: 0 10px; }
    h2 { color: #333; }
    label { display: block; margin: 10px 0 4px; }
    input[type="range"] { width: 100%; }
    .score-display { display: inline-block; width: 40px; text-align: center; }
    button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
    .export-btn { background: #28a745; color: white; border: none; }
    .save-btn { background: #007bff; color: white; border: none; }
    select, button { font-size: 16px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2 id="welcome">Loading...</h2>
  <div id="judgeView" class="hidden">
    <label for="teamSelect">Select Team:</label>
    <select id="teamSelect"></select>

    <div id="scoringForm" class="hidden">
      <h3>Score Team: <span id="selectedTeam"></span></h3>
      <form id="scoreForm"></form>
      <button class="save-btn" onclick="saveScores()">Save Scores</button>
    </div>
  </div>

  <button id="exportBtn" class="export-btn hidden" onclick="exportRankings()">
    Export Team Rankings (CSV)
  </button>

  <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
  <script>
    // ðŸ”‘ REPLACE WITH YOUR BACK4APP KEYS
    Parse.initialize("616v52r1VZAEAeOUziBe8XveApnpTXEwUVKg1Dps", "CQk3Ng8VjGqae0qYNvHRlimHpNHks1iAzkBUXxSc");
    Parse.serverURL = "https://parseapi.back4app.com";

    let currentJudgeId = null;
    let currentJudgeName = null;
    let isMaster = false;
    let criteriaList = [];
    let teamList = [];

    window.onload = async function () {
      try {
        const user = await Parse.User.currentAsync();
        if (!user) {
          window.location.href = "index.html";
          return;
        }

        currentJudgeId = user.get("judge_id"); // e.g., "J012"
        if (!currentJudgeId) throw new Error("User missing judge_id");

        // Fetch judge info
        const judgeQuery = new Parse.Query("judge");
        const judge = await judgeQuery.equalTo("judge_id", currentJudgeId).first();
        if (!judge) throw new Error("Judge not found");

        currentJudgeName = judge.get("judge_name");
        isMaster = judge.get("isMaster") === true;

        document.getElementById("welcome").innerText = `Welcome, ${currentJudgeName}!`;

        // Load criteria
        const critQuery = new Parse.Query("Criteria");
        criteriaList = await critQuery.ascending("criteria_code").find();

        // Load teams
        const teamQuery = new Parse.Query("Team");
        teamList = await teamQuery.ascending("team_code").find();

        if (teamList.length === 0) {
          document.getElementById("welcome").innerText += " (No teams available)";
          return;
        }

        // Populate team dropdown
        const select = document.getElementById("teamSelect");
        teamList.forEach(team => {
          const opt = document.createElement("option");
          opt.value = team.get("team_code");
          opt.text = `${team.get("team_code")} - ${team.get("team_name") || ""}`;
          select.appendChild(opt);
        });

        document.getElementById("judgeView").classList.remove("hidden");

        if (isMaster) {
          document.getElementById("exportBtn").classList.remove("hidden");
        }

        select.addEventListener("change", loadScoringForm);

      } catch (error) {
        console.error("Init error:", error);
        alert("Error: " + error.message + ". Redirecting to login.");
        window.location.href = "index.html";
      }
    };

    function loadScoringForm() {
      const teamCode = document.getElementById("teamSelect").value;
      if (!teamCode) return;

      const team = teamList.find(t => t.get("team_code") === teamCode);
      document.getElementById("selectedTeam").innerText = team.get("team_code");

      const formHtml = criteriaList.map(crit => {
        const code = crit.get("criteria_code");
        const name = crit.get("criteria_name");
        return `
          <label>
            ${name} (${code})
            <input type="range" min="0" max="10" step="0.5" id="score_${code}" value="5">
            <span class="score-display" id="disp_${code}">5</span>
          </label>
        `;
      }).join("");

      document.getElementById("scoreForm").innerHTML = formHtml;
      document.getElementById("scoringForm").classList.remove("hidden");

      criteriaList.forEach(crit => {
        const code = crit.get("criteria_code");
        const slider = document.getElementById(`score_${code}`);
        const disp = document.getElementById(`disp_${code}`);
        slider.oninput = () => disp.innerText = slider.value;
      });
    }

    async function saveScores() {
      const teamCode = document.getElementById("teamSelect").value;
      if (!teamCode) return;

      const scores = {};
      criteriaList.forEach(crit => {
        const code = crit.get("criteria_code");
        const val = parseFloat(document.getElementById(`score_${code}`).value);
        if (!isNaN(val)) scores[code] = val;
      });

      try {
        // Check for existing scores (optional overwrite protection)
        const existingQuery = new Parse.Query("Score");
        existingQuery.equalTo("judge_id", currentJudgeId);
        existingQuery.equalTo("team_code", teamCode);
        const existing = await existingQuery.find();

        if (existing.length > 0) {
          if (!confirm("You've already scored this team. Overwrite?")) return;
          await Parse.Object.destroyAll(existing);
        }

        // Save new scores
        for (const crit of criteriaList) {
          const code = crit.get("criteria_code");
          const ScoreClass = Parse.Object.extend("Score");
          const scoreObj = new ScoreClass();
          scoreObj.set("judge_id", currentJudgeId);
          scoreObj.set("team_code", teamCode);
          scoreObj.set("criteria_code", code);
          scoreObj.set("score", scores[code]);
          await scoreObj.save();
        }

        alert("Scores saved successfully!");
      } catch (error) {
        console.error("Save error:", error);
        alert("Failed to save: " + error.message);
      }
    }

    async function exportRankings() {
      try {
        const scoreQuery = new Parse.Query("Score");
        const allScores = await scoreQuery.find();

        const teamTotals = {};
        allScores.forEach(s => {
          const teamCode = s.get("team_code");
          if (!teamTotals[teamCode]) teamTotals[teamCode] = 0;
          teamTotals[teamCode] += s.get("score");
        });

        const rankings = Object.entries(teamTotals)
          .map(([teamCode, total]) => ({ teamCode, total: parseFloat(total.toFixed(2)) }))
          .sort((a, b) => b.total - a.total);

        // Generate CSV
        let csv = "Rank,Team Code,Total Score\n";
        rankings.forEach((r, i) => {
          csv += `${i + 1},${r.teamCode},${r.total}\n`;
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "team_rankings.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error("Export error:", error);
        alert("Export failed: " + error.message);
      }
    }
  </script>
</body>
</html>