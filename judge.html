<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Judging Dashboard</title>
  <style>
    body { font-family: "Segoe UI", Arial; background:#f4f6fa; margin:0; color:#333; }
    header {
      background:#004aad; color:white; padding:15px 25px;
      display:flex; justify-content:space-between; align-items:center;
    }
    main {
      max-width:900px; margin:30px auto; background:white;
      padding:30px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1);
    }
    h2 { color:#004aad; }
    label { display:block; margin-top:15px; font-weight:500; }
    select,input[type=range] {
      width:100%; padding:8px; border:1px solid #ccc; border-radius:8px;
      font-size:15px; margin-top:5px;
    }
    button {
      margin-top:20px; background:#007bff; color:white; border:none;
      border-radius:8px; padding:12px 20px; font-weight:600; cursor:pointer;
    }
    button:hover { background:#005fcc; }
    .score-display {
      background:#007bff; color:white; border-radius:50%;
      display:inline-block; width:35px; height:35px; line-height:35px;
      text-align:center; margin-left:10px;
    }
    .alert { background:#e8f9f0; padding:10px 15px; border-left:4px solid #28a745; border-radius:8px; margin-bottom:10px; color:#2d7a46; }
  </style>
</head>
<body>
  <header>
    <h2>Judging Dashboard</h2>
    <button onclick="logout()">Logout</button>
  </header>

  <main>
    <label>Select Team:</label>
    <select id="teamSelect"></select>

    <div id="criteriaForm" style="margin-top:20px;"></div>

    <button onclick="saveScores()">üíæ Save Scores</button>
    <hr>
    <button onclick="exportCSV()">‚¨áÔ∏è Export CSV (Master only)</button>
  </main>

  <script>
    const API = "https://judging-system.yeewengloke.workers.dev";
    let judge_id = localStorage.getItem("judge_id");

    if (!judge_id) window.location.href = "index.html";

    const teamSelect = document.getElementById("teamSelect");
    const formDiv = document.getElementById("criteriaForm");
    let criteriaList = [];

    // Load teams and criteria once on startup
    async function init() {
      // Load criteria (static)
      const criteriaRes = await fetch(API + "/criteria");
      criteriaList = await criteriaRes.json();

      // Load teams
      const teamsRes = await fetch(API + "/teams");
      const teams = await teamsRes.json();
      teams.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.team_code;
        opt.textContent = `${t.team_code} - ${t.team_name}`;
        teamSelect.appendChild(opt);
      });

      // Set up team change listener
      teamSelect.addEventListener("change", () => {
        if (teamSelect.value) {
          loadTeamScores(teamSelect.value);
        } else {
          formDiv.innerHTML = "";
        }
      });

      // Trigger initial load if a team is pre-selected (optional)
    }

    // Load and display scores for selected team
    async function loadTeamScores(team_code) {
      // Reset form
      formDiv.innerHTML = criteriaList.map(c => `
        <label>${c.criteria_name} (${c.criteria_code})
          <input type="range" id="${c.criteria_code}" min="0" max="10" step="1" value="0">
          <span class="score-display" id="disp_${c.criteria_code}">0</span>
        </label>
      `).join("");

      // Attach live update
      criteriaList.forEach(c => {
        const slider = document.getElementById(c.criteria_code);
        const disp = document.getElementById("disp_" + c.criteria_code);
        slider.oninput = () => disp.textContent = slider.value;
      });

      // Fetch existing scores
      try {
        const res = await fetch(`${API}/scores?judge_id=${judge_id}&team_code=${team_code}`);
        const existing = await res.json();

        if (existing && Object.keys(existing).length > 0) {
          // Show alert
          const alertDiv = document.createElement("div");
          alertDiv.className = "alert";
          alertDiv.textContent = "‚úÖ Already scored ‚Äî you may update and resave.";
          formDiv.prepend(alertDiv);

          // Fill sliders with saved values
          criteriaList.forEach(c => {
            const saved = existing[c.criteria_code];
            if (saved !== undefined) {
              const slider = document.getElementById(c.criteria_code);
              slider.value = saved;
              document.getElementById("disp_" + c.criteria_code).textContent = saved;
            }
          });
        }
      } catch (err) {
        console.warn("Could not load existing scores", err);
      }
    }

    async function saveScores() {
      const team_code = teamSelect.value;
      if (!team_code) return alert("Please select a team.");

      const scores = {};
      document.querySelectorAll("input[type=range]").forEach(i => {
        scores[i.id] = parseFloat(i.value);
      });

      const res = await fetch(API + "/scores", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ judge_id, team_code, scores }),
      });

      const data = await res.json();
      if (data.success) {
        alert("‚úÖ Scores saved!");
        // Optional: disable editing after save (but you want to allow edits, so skip)
      } else {
        alert("‚ùå Save failed: " + (data.error || "Unknown error"));
      }
    }

    async function exportCSV() {
      window.location.href = API + "/export";
    }

    function logout() {
      localStorage.removeItem("judge_id");
      window.location.href = "index.html";
    }

    // Start app
    init();
  </script>
</body>
</html>
