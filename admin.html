<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin — Judging Dashboard</title>
  <style>
    :root {
      --brand:#004aad;
      --btn: #ffffff;
      --btnr:#ff0000;
      --btnb:#0063e5;
      --btn-hover:#68aeff;
      --bg:#ffffff;
      --card:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
    }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: var(--bg); color: #333; }

    header {
      background: var(--brand); color: #fff;
      padding: 14px 22px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 3px 12px rgba(0,0,0,.12);
    }
    header h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
    header .right { display: flex; gap: 8px; align-items: center; }

    main {
      max-width: 1100px; margin: 28px auto; padding: 0 20px;
    }

    /* Toolbar */
    .toolbar {
      display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px;
      margin-bottom: 16px;
    }
    .tbtn {
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      padding: 12px 14px; font-weight: 600; cursor: pointer; text-align: center;
      transition: background .2s, border-color .2s, transform .02s;
    }
    .tbtn:hover { background: #f8fafc; }
    .tbtn:active { transform: translateY(1px); }
    .tbtn.active { border-color: var(--btn); outline: 2px solid #dbeafe; }

    /* Panels */
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      padding: 18px 18px; box-shadow: 0 10px 24px rgba(0,0,0,.06);
      min-height: 220px;
    }
    .panel { display: none; }
    .panel.active { display: block; }

    h2 { margin: 0 0 6px; color: var(--brand); font-size: 18px; }
    .muted { color: var(--muted); font-size: 14px; }

    /* Placeholder “blank” states */
    .blank {
      border: 2px dashed #d1d5db; border-radius: 12px; padding: 26px; text-align: center; color: var(--muted);
      background: #fafafa;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 14px; }
    select, input, button {
      font-size: 15px;
    }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: #fff;
    }

    .btn {
      background: var(--btn); color: #000000; border: none; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer;
    }
    
    .btn:hover { background: var(--btn-hover); }

    .btnr {
      background: var(--btnr); color: #000000; border: none; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer;
    }
    
    .btn:hover { background: var(--btn-hover); }

    .btnb {
      background: var(--btnb); color: #000000; border: none; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer;
    }

    .btn:hover { background: var(--btn-hover); }

    /* Tiny helper for section toolbars */
    .sectionbar {
      display: flex; gap: 8px; align-items: center; margin: 10px 0 16px;
    }
    .spacer { flex: 1; }

    /* --- Assign grid: three columns: team | nav buttons | judge --- */
    .assign-grid {
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;            /* line up with dropdowns */
      gap:20px;
    }

    /* Side-by-side dropdowns (team + judge) */
  .assign-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-top: 16px;
  }

  .assign-col {
    flex: 1; /* each takes equal width */
  }

  .assign-col select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: #fff;
  }

.assign-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;  /* <-- was 'end' */
  gap: 20px;
  margin-bottom: 16px;
}

.assign-top .assign-col { flex: 1; }


.assign-top .assign-col.right {
  text-align: right;
}

.assign-top .assign-col.right select {
  width: 60%;          /* makes the judge dropdown smaller and right-aligned */
}

@media (max-width: 768px) {
  .assign-top {
    flex-direction: column;
    align-items: stretch;
  }
  .assign-top .assign-col.right select {
    width: 100%;
  }
}

    /* Middle column: put buttons side-by-side, centered */
    .assign-nav{
      display:flex !important;       /* ensure flex */
      flex-direction:column !important; /* side-by-side, not stacked */
      align-items:center;
      justify-content:center;
      gap:12px;
    }

    /* In case a global .btn makes buttons block-level */
    .assign-nav .btn, .assign-nav button{
      width: 120px;
      height: 42px;
      display:inline-flex !important;
      align-items:center;
      justify-content:center;
      min-width:90px;                /* optional: consistent width */
    }

.blank-row {
  display: flex;
  gap: 20px;
  margin-top: 20px;
  height: 60vh;                 /* overall row height proportional to screen */
}

.blank {
  flex: 1;
  overflow: hidden;             /* prevent layout overflow */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}


    .btn-bar {
      display: flex;
      justify-content: right;
      gap: 20px;
    }

    .radio-list .radio-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
      background: #fff;
    }

    /* Make team list adapt to screen height and scroll if long */
#teamsList {
  max-height: 50vh;             /* takes up to half the viewport height */
  overflow-y: auto;             /* scrolls vertically when too long */
  padding-right: 6px;           /* avoid scrollbar overlap */
  scroll-behavior: smooth;
}

/* Optional: hide ugly scrollbar for better aesthetics (for WebKit browsers) */
#teamsList::-webkit-scrollbar {
  width: 6px;
}
#teamsList::-webkit-scrollbar-thumb {
  background-color: #cbd5e1;
  border-radius: 6px;
}
#teamsList::-webkit-scrollbar-thumb:hover {
  background-color: #94a3b8;
}


    .radio-list .team-code {
      font-weight: 600;
      min-width: 80px;
      color: #1f2937;
    }

    .radio-list .team-name {
      color: #374151;
    }

    .assign-top{ display:flex; gap:20px; align-items:flex-end; margin-bottom:16px; }
.assign-top .assign-col{ flex:1; }

.assign-boards{
  display:grid;
  grid-template-columns: 1fr auto 1fr; /* left | middle | right */
  gap:20px;
  align-items: stretch;
}

.list{
  border:1px solid var(--border);
  border-radius:12px;
  background:#fff;
  padding:10px;
  display:flex;
  flex-direction:column;
  min-height:260px;
}
.list-title{ font-weight:700; color:#334155; margin:4px 6px 8px; }

.scroll{ overflow-y:auto; max-height:50vh; padding-right:6px; }
.scroll::-webkit-scrollbar{ width:6px; }
.scroll::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:6px; }
.scroll::-webkit-scrollbar-thumb:hover{ background:#94a3b8; }

.assign-nav{ display:flex; flex-direction:column; gap:12px; justify-content:center; align-items:center; }
.assign-nav button{ width:120px; height:42px; display:inline-flex; align-items:center; justify-content:center; }

.radio-list .radio-item{
  display:flex; align-items:center; gap:10px;
  padding:8px 10px; margin-bottom:8px;
  border:1px solid var(--border); border-radius:10px; background:#fff;
}
.radio-list .team-code{ font-weight:600; min-width:80px; color:#1f2937; }
.radio-list input[type=checkbox]{ transform: scale(1.1); }

@media (max-width:820px){
  .assign-top{ flex-direction:column; align-items:stretch; }
  .assign-boards{ grid-template-columns: 1fr; }
  .assign-nav{ flex-direction:row; }
}


  </style>

</head>
<body>
  <header>
    <h1>Admin — Judging Dashboard</h1>
    <div class="right">
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <main>
    <!-- Top toolbar -->
    <div class="toolbar" role="tablist" aria-label="Admin actions">
      <button id="btnAssign" class="tbtn" role="tab" aria-controls="panelAssign" aria-selected="false">Assign Teams</button>
      <button id="btnViewer" class="tbtn" role="tab" aria-controls="panelViewer" aria-selected="false">Score Viewer</button>
      <button id="btnTeams"  class="tbtn" role="tab" aria-controls="panelTeams"  aria-selected="false">Team List</button>
      <button id="btnJudges" class="tbtn" role="tab" aria-controls="panelJudges" aria-selected="false">Judge List</button>
    </div>

<section id="panelAssign" class="panel card" role="tabpanel" aria-labelledby="btnAssign">
  <h2>Assign Teams</h2>

  <!-- Top row: Team Categories (left) + Judge Names (right) -->
  <div class="assign-top">
    <div class="assign-col">
      <label class="muted" for="category">Team Categories</label>
      <select id="category">
        <option value="">— Select a category —</option>
        <option value="IITS Primary">IITS Primary</option>
        <option value="Secondary Group">Secondary Group</option>
        <option value="Friendship Exchange">Friendship Exchange</option>
      </select>
    </div>

    <div class="assign-col">
      <label class="muted" for="judgeSelect">Judge Names</label>
      <select id="judgeSelect">
        <option value="">— Select judge —</option>
        <!-- filled by JS -->
      </select>
    </div>
  </div>

  <!-- Boards: Available | Buttons | Assigned (under judge) -->
  <div class="assign-boards">
    <!-- LEFT: Available teams (checkbox, multi-select) -->
    <div class="list">
      <div class="list-title">Available Teams</div>
      <div id="teamsList" class="radio-list scroll"></div>
    </div>

    <!-- MIDDLE: Buttons -->
    <div class="assign-nav">
      <button class="btnb" id="btnAdd">➡️ Add</button>
      <button class="btnr" id="btnRemove">⬅️ Remove</button>
      <button type="button" id="btnSave" class="btnb">💾 Save</button>
    </div>

    <!-- RIGHT: Assigned to selected judge (for selected category) -->
    <div class="list">
      <div class="list-title">
        Assigned <span id="assignedHeaderSuffix" class="muted"></span>
      </div>
      <div id="assignedList" class="radio-list scroll"></div>
    </div>
  </div>
</section>

  <!-- If you want middle buttons + right list later, add them below as a separate row -->
  <!-- <div class="assign-boards"> ... </div> -->
</section>





<!-- <div class="blank" id="teamsBox">
    <div id="teamsList" class="radio-list"></div>
  </div> -->


  <!-- Right box: judges -->
  <!-- <div class="blank" id="judgesBox">
    <select id="judgeSelect">
      <option>Judge 1</option>
      <option>Judge 2</option>
    </select>
  </div>
</div>
</div> -->

</section>
    <section id="panelViewer" class="panel card" role="tabpanel" aria-labelledby="btnViewer">
      <h2>Score Viewer</h2>
      <div class="muted">Filter by team or judge to view saved scores. (This is a placeholder.)</div>

      <div class="sectionbar">
        <select><option>Filter by team (coming soon)</option></select>
        <select><option>Filter by judge (coming soon)</option></select>
        <div class="spacer"></div>
        <button class="btnr">⬇️ Export CSV</button>
      </div>

      <div class="blank">
        A read-only table of scores will appear here once connected.
      </div>
    </section>

    <section id="panelTeams" class="panel card" role="tabpanel" aria-labelledby="btnTeams">
      <h2>Team List</h2>
      <div class="muted">Browse and search teams. (Placeholder list/search UI.)</div>

      <div class="sectionbar">
        <input type="text" placeholder="Search teams…" />
        <div class="spacer"></div>
        <button class="tbtn" >⟳ Refresh</button>
        <input type="text" placeholder="New team..."  />
        <div class="spacer"></div>
        <button class="tbtn" >➕ Add</button>
      </div>

      <div class="blank">
        Teams table will render here.
      </div>
    </section>

    <section id="panelJudges" class="panel card" role="tabpanel" aria-labelledby="btnJudges">
      <h2>Judge List</h2>
      <div class="muted">Browse and search judges. (Placeholder list/search UI.)</div>

      <div class="sectionbar">
        <input type="text" placeholder="Search judges…" />
        <div class="spacer"></div>
        <button class="tbtn" >⟳ Refresh</button>
        <input type="text" placeholder="New judge..." />
        <div class="spacer"></div>
        <button class="tbtn" >➕ Add</button>
      </div>

      <div class="blank">
        Judges table will render here.
      </div>
    </section>
  </main>

  <script>
  const API = "https://judging-system.yeewengloke.workers.dev";
  let judge_id = localStorage.getItem("judge_id");

  const catSel = document.getElementById("category");
  const teamsList = document.getElementById("teamsList");

  // render helper
  function renderTeamsRadios(teams) {
    if (!Array.isArray(teams) || teams.length === 0) {
      teamsList.innerHTML = `<div class="muted" style="padding:10px 0;">No teams for this category yet.</div>`;
      return;
    }

    // name="teamPick" makes them mutually exclusive (radio behavior)
    teamsList.innerHTML = teams.map(t => `
      <label class="radio-item">
        <input type="checkbox" name="teamPick" value="${t.team_code}">
        <span class="team-code">${t.team_code}</span>
        <span class="team-name">${t.team_name ?? ""}</span>
      </label>
      `).join("");
    }

  // load teams for selected category
const teamsByCategory = {}; // store separate lists for each category

async function loadTeamsForCategory(category) {
  if (teamsByCategory[category]) {
    // Already loaded before — just render from memory
    renderTeamsRadios(teamsByCategory[category]);
    return;
  }

  teamsList.innerHTML = `<div class="muted" style="padding:10px 0;">Loading…</div>`;
  try {
    const url = new URL(`${API}/teams`);
    if (category) url.searchParams.set("category", category);
    const res = await fetch(url);
    const data = await res.json();

    // Apply prefix filter
    let prefix = "";
    if (category === "IITS Primary") prefix = "IP";
    else if (category === "Secondary Group") prefix = "IS";
    else if (category === "Friendship Exchange") prefix = "FE";

    const filtered = data.filter(t => (t.team_code || "").startsWith(prefix));

    // Cache it
    teamsByCategory[category] = filtered;
    renderTeamsRadios(filtered);
  } catch (e) {
    console.error(e);
    teamsList.innerHTML = `<div class="muted" style="padding:10px 0; color:#b91c1c;">Failed to load teams.</div>`;
  }
}

catSel.addEventListener("change", () => {
  const category = catSel.value;
  if (!category) return;

  // Don’t erase others — just render the one selected
  loadTeamsForCategory(category);
});


// optional: preload a default category
// catSel.value = "IITS Primary";
// loadTeamsForCategory(catSel.value);

// reading the chosen team later:
function getSelectedTeamCode() {
  const checked = document.querySelector('input[name="teamPick"]:checked');
  return checked ? checked.value : "";
}
    // Basic panel toggler: activate only the one you click, keep others blank/hidden.
    const tabs = [
      { btn: 'btnAssign', panel: 'panelAssign' },
      { btn: 'btnViewer', panel: 'panelViewer' },
      { btn: 'btnTeams',  panel: 'panelTeams'  },
      { btn: 'btnJudges', panel: 'panelJudges' },
    ];

    function showPanel(panelId, btnId) {
      // toggle buttons
      tabs.forEach(({btn}) => {
        const el = document.getElementById(btn);
        if (!el) return;
        const active = btn === btnId;
        el.classList.toggle('active', active);
        el.setAttribute('aria-selected', active ? 'true' : 'false');
      });
      // toggle panels
      tabs.forEach(({panel}) => {
        const el = document.getElementById(panel);
        if (!el) return;
        el.classList.toggle('active', panel === panelId);
      });
    }

    // Wire up clicks
    tabs.forEach(({btn, panel}) => {
      const b = document.getElementById(btn);
      b?.addEventListener('click', () => showPanel(panel, btn));
      // keyboard access (Enter/Space)
      b?.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showPanel(panel, btn); }
      });
    });

async function loadJudges() {
  const judgeSel = document.getElementById("judgeSelect");
  judgeSel.innerHTML = `<option value="">Loading…</option>`;
  try {
    const res = await fetch("https://judging-system.yeewengloke.workers.dev/judges");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    // Populate dropdown
    judgeSel.innerHTML =
      `<option value="">— Select judge —</option>` +
      data.map(j => `<option value="${j.judge_id}">${j.judge_name}</option>`).join("");
  } catch (err) {
    console.error(err);
    judgeSel.innerHTML = `<option value="">Failed to load judges</option>`;
  }
}

// Load judges once the page is ready
window.addEventListener("DOMContentLoaded", loadJudges);
    // Start blank: no panel active at load.
    // (If you prefer a default, uncomment the next line)
    // showPanel('panelAssign', 'btnAssign');

    // Logout placeholder (hook to your real logic)
    
    // collect checked team codes from the left list
    function getCheckedTeamCodes() {
  return Array.from(document.querySelectorAll('#teamsList input[type="checkbox"]:checked'))
    .map(cb => cb.value);
}

const saveBtn  = document.getElementById("btnSave");
const judgeSel = document.getElementById("judgeSelect");

function getCheckedTeamCodes() {
  return Array.from(document.querySelectorAll('#teamsList input[type="checkbox"]:checked'))
    .map(cb => cb.value);
}

async function saveAssignments() {
  const judge_id = judgeSel.value;
  if (!judge_id) { alert("Please select a judge."); return; }

  const team_codes = getCheckedTeamCodes();
  if (team_codes.length === 0) { alert("Please select at least one team."); return; }

  try {
    const res = await fetch(`${API}/assigned-teams`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ judge_id, team_codes })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.success) {
      throw new Error(data.error || `HTTP ${res.status}`);
    }

    alert(`✅ Saved ${team_codes.length} assignment(s).`);

    // optional: uncheck boxes
    document.querySelectorAll('#teamsList input[type="checkbox"]:checked')
      .forEach(cb => (cb.checked = false));

  } catch (err) {
    console.error("Save failed:", err);
    alert("❌ Failed to save assignments. See console.");
  }
}

saveBtn?.addEventListener("click", saveAssignments);

document.getElementById('logoutBtn')?.addEventListener('click', () => {
  // localStorage.removeItem("judge_id");
  // window.location.href = "index.html";
  alert('Logout clicked (wire this to your auth).');
});

  </script>
</body>
</html>
